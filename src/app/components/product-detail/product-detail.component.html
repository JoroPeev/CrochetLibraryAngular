<div class="product-detail-container">
    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading">Loading...</div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

    <!-- Product Details -->
    <div *ngIf="product && !isLoading" class="product-detail card">
        <h2 class="product-title">{{ product.name }}</h2>

        <!-- Image Slideshow -->
        <div class="slideshow">
            <button class="nav-btn" (click)="prevImage()" [disabled]="toyImages.length <= 1">⟨</button>
            <img [src]="currentImage" (error)="onImageError($event)" alt="Product Image" />
            <button class="nav-btn" (click)="nextImage()" [disabled]="toyImages.length <= 1">⟩</button>
        </div>

        <!-- Request Button -->
        <button *ngIf="showRequestButton" (click)="openRequestModal()" class="btn-primary">
            Request Product
        </button>

        <!-- Reviews -->
        <div class="reviews-section">
            <h3>Reviews</h3>

            <!-- Average rating -->
            <div *ngIf="product.reviews?.length" class="average-rating">
                <strong>Average Rating:</strong>
                <span *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= Math.round(averageRating)">★</span>
                <span class="rating-number">({{ averageRating | number:'1.1-1' }}/5)</span>
            </div>

            <!-- Individual reviews -->
            <div *ngIf="product.reviews?.length; else noReviews" class="review-list">
                <div *ngFor="let review of product.reviews" class="review card">
                    <p class="review-header">
                        <strong>{{ review.name }}</strong>
                        <span class="review-date">({{ review.reviewDate | date: 'short' }})</span>
                    </p>
                    <div class="star-rating readonly">
                        <span *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= review.customerRating">★</span>
                    </div>
                    <p class="review-comment">{{ review.comment }}</p>
                </div>
            </div>
            <ng-template #noReviews>
                <p>No reviews yet.</p>
            </ng-template>

            <button (click)="toggleReviewForm()" class="btn-secondary">
                {{ showReviewForm ? 'Cancel' : 'Write a Review' }}
            </button>

            <!-- Review Form -->
            <div *ngIf="showReviewForm" class="review-form card">
                <h4>Write a Review</h4>
                <form #reviewForm="ngForm" (ngSubmit)="submitReview()">
                    <label>Name:</label>
                    <input [(ngModel)]="newReview.name" name="reviewerName" required />

                    <label>Email:</label>
                    <input [(ngModel)]="newReview.emailAddress" name="reviewerEmail" type="email" required />

                    <label>Rating:</label>
                    <div class="star-rating">
                        <span *ngFor="let star of [1,2,3,4,5]" (click)="setRating(star)"
                            (mouseover)="hoverRating = star" (mouseleave)="hoverRating = 0"
                            [class.filled]="star <= (hoverRating || newReview.customerRating)">
                            ★
                        </span>
                    </div>
                    <div class="error-message" *ngIf="errorMessage && newReview.customerRating === 0">
                        {{ errorMessage }}
                    </div>

                    <label>Comment:</label>
                    <textarea [(ngModel)]="newReview.comment" name="reviewerComment" required></textarea>

                    <button type="submit" class="btn-primary" [disabled]="isLoading">
                        {{ isLoading ? 'Submitting...' : 'Submit Review' }}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div *ngIf="showRequestModal" class="modal">
        <div class="modal-content card">
            <span class="close" (click)="closeRequestModal()">&times;</span>
            <div *ngIf="showThankYou; else requestForm">
                <h3>Thank You!</h3>
                <p>Your request has been submitted.</p>
                <button (click)="closeRequestModal()" class="btn-primary">Close</button>
            </div>
            <ng-template #requestForm>
                <h3>Request Product: {{ product?.name }}</h3>
                <form #requestForm="ngForm" (ngSubmit)="submitRequest()">
                    <label>Name:</label>
                    <input [(ngModel)]="requestData.name" name="requestName" required />

                    <label>Email:</label>
                    <input [(ngModel)]="requestData.email" name="requestEmail" type="email" required />

                    <label>Message:</label>
                    <textarea [(ngModel)]="requestData.message" name="requestMessage"></textarea>

                    <label>Due Date:</label>
                    <input [(ngModel)]="requestData.dueDate" name="requestDueDate" type="date" required />

                    <label class="checkbox">
                        <input [(ngModel)]="requestData.newsletter" name="newsletter" type="checkbox" />
                        Subscribe to Newsletter
                    </label>

                    <button type="submit" class="btn-primary" [disabled]="isLoading">
                        {{ isLoading ? 'Submitting...' : 'Submit Request' }}
                    </button>
                </form>
            </ng-template>
        </div>
    </div>
</div>